<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InnovaTrack - Attendance Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex items-center justify-center">

<!-- LOGIN PAGE -->
<div id="loginPage" class="bg-white p-10 rounded-2xl shadow-lg w-full max-w-sm">
  <img src="logo.png" class="w-20 h-20 mx-auto rounded-full mb-4">
  <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">InnovaTrack Login</h2>
  <input id="username" type="text" placeholder="Username" class="border p-3 rounded-md w-full mb-4">
  <input id="password" type="password" placeholder="Password" class="border p-3 rounded-md w-full mb-6">
  <button onclick="login()" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700">Login</button>
  <p id="loginError" class="text-red-500 mt-3 text-center hidden">Invalid credentials!</p>
  <p class="mt-4 text-sm text-gray-600 text-center">Don't have an account? <span onclick="showSignUp()" class="text-indigo-600 cursor-pointer">Sign Up</span></p>
</div>

<!-- SIGN UP PAGE -->
<div id="signUpPage" class="bg-white p-10 rounded-2xl shadow-lg w-full max-w-sm hidden">
  <img src="logo.png" class="w-20 h-20 mx-auto rounded-full mb-4">
  <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Sign Up</h2>
  <input id="newUsername" type="text" placeholder="Username" class="border p-3 rounded-md w-full mb-4">
  <input id="newPassword" type="password" placeholder="Password" class="border p-3 rounded-md w-full mb-6">
  <button onclick="signUp()" class="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700">Register</button>
  <p class="mt-4 text-sm text-gray-600 text-center">Already have an account? <span onclick="showLogin()" class="text-indigo-600 cursor-pointer">Login</span></p>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden w-full max-w-7xl p-6">

  <!-- Header -->
  <header class="bg-indigo-600 text-white p-4 rounded-xl shadow-md mb-6 flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <img src="logo.png" class="w-10 h-10 rounded-full">
      <h1 class="text-2xl font-bold">InnovaTrack Dashboard</h1>
    </div>
    <div class="flex items-center space-x-4">
      <span id="currentDate" class="text-sm"></span>
      <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-600">Logout</button>
    </div>
  </header>

  <!-- Tabs -->
  <div class="flex space-x-2 mb-6">
    <button class="tab-btn px-4 py-2 rounded-full bg-indigo-600 text-white" data-tab="seatPlan">Seat Plan</button>
    <button class="tab-btn px-4 py-2 rounded-full bg-gray-200 text-gray-700" data-tab="qrScanner">QR Scanner</button>
    <button class="tab-btn px-4 py-2 rounded-full bg-gray-200 text-gray-700" data-tab="qrGenerator">QR Generator</button>
    <button class="tab-btn px-4 py-2 rounded-full bg-gray-200 text-gray-700" data-tab="pdfPreviewTab">PDF Preview</button>
  </div>

  <!-- SEAT PLAN -->
  <div id="seatPlan" class="tab-section bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Classroom Seat Plan</h2>

    <!-- STUDENT REGISTRATION -->
<div class="mb-4 flex gap-2">
  <input id="studentNoInput" type="text" placeholder="Student No." class="border p-2 rounded w-1/4">
  <input id="studentNameInput" type="text" placeholder="Student Name" class="border p-2 rounded w-1/2">
  <button onclick="addStudent()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Register Student</button>
</div>


    <div id="seatContainer" class="grid grid-cols-5 gap-4 mb-4"></div>
    <div class="flex gap-3 mt-5">
      <button onclick="markAllPresent()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Mark All Present</button>
      <button onclick="resetSeats()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Reset</button>
      <button onclick="generatePdfPreview()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Preview PDF</button>
    </div>
  </div>

  <!-- QR SCANNER -->
  <div id="qrScanner" class="tab-section hidden bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">QR Scanner</h2>
    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Camera Scanner -->
      <div class="bg-indigo-50 p-6 rounded-xl shadow-md text-center">
        <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2">
          <i class="ri-camera-line text-indigo-600 text-4xl"></i>
        </div>
        <p class="font-semibold text-gray-900 mb-3">Start Camera QR Scan</p>
        <button id="startCameraBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-2">Start Camera</button>
        <div id="reader" style="width:100%;"></div>
        <button onclick="captureQR()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mt-2">Capture</button>
        <p class="mt-2">Scanned Seat: <span id="scannedSeat" class="font-bold text-green-600">None</span></p>
      </div>
      <!-- Manual QR Input -->
      <div>
        <h3 class="text-sm font-medium text-gray-700 mb-3">Manual QR Entry</h3>
        <input id="manualQr" placeholder="Enter QR code (e.g., 1-Juan)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500">
        <button id="manualSubmit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Mark Attendance</button>
      </div>
    </div>
  </div>

  <!-- QR GENERATOR -->
  <div id="qrGenerator" class="tab-section hidden bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">QR Generator</h2>
    <div class="mb-6">
      <input id="genSeat" placeholder="Seat Number" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
      <input id="genName" placeholder="Student Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
      <button id="generateBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Generate QR</button>
      <div id="qrcode" class="mt-3"></div>
      <a id="downloadLink" class="text-blue-600 mt-2 inline-block" download="">Download QR</a>
    </div>
    <button id="generateAllBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4">Generate All Students QR</button>
    <div id="allQRCodes" class="grid grid-cols-4 gap-4"></div>
  </div>

  <!-- PDF Preview -->
  <div id="pdfPreviewTab" class="tab-section hidden bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-xl font-semibold text-gray-900 mb-4">Monthly Attendance PDF Preview</h2>
    <iframe id="pdfPreviewFrame" class="w-full h-[600px] border rounded-lg mb-4"></iframe>
    <button onclick="generatePdfPreview()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mr-2">Generate PDF Preview</button>
    <button id="downloadPdfBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Download PDF</button>
  </div>

</div>

<script>
let students=[];
let currentUser=null;

// Update date
function updateDate(){
  const now=new Date();
  const options={weekday:'short',month:'short',day:'numeric',year:'numeric'};
  document.getElementById('currentDate').textContent=now.toLocaleDateString('en-US',options);
}
setInterval(updateDate,1000);

// LOGIN / SIGNUP
const users=[{username:"admin",password:"1234"}];
function login(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value.trim();
  const user=users.find(x=>x.username===u && x.password===p);
  if(user){
    currentUser=u;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('signUpPage').classList.add('hidden');
    document.getElementById('dashboardPage').classList.remove('hidden');
    generateSeats();
  }else document.getElementById('loginError').classList.remove('hidden');
}
function signUp(){
  const u=document.getElementById('newUsername').value.trim();
  const p=document.getElementById('newPassword').value.trim();
  if(u && p){
    users.push({username:u,password:p});
    alert("Account created! Please login.");
    showLogin();
  }
}
function showSignUp(){document.getElementById('loginPage').classList.add('hidden'); document.getElementById('signUpPage').classList.remove('hidden');}
function showLogin(){document.getElementById('signUpPage').classList.add('hidden'); document.getElementById('loginPage').classList.remove('hidden');}
function logout(){document.getElementById('dashboardPage').classList.add('hidden');document.getElementById('loginPage').classList.remove('hidden');}

// SEAT PLAN
function addStudent(){
  const noInput = document.getElementById('studentNoInput');
  const nameInput = document.getElementById('studentNameInput');
  const studentNo = noInput.value.trim();
  const name = nameInput.value.trim();
  if(!studentNo || !name) return alert("Enter student number and name!");
  students.push({no: studentNo, name: name});
  noInput.value = '';
  nameInput.value = '';
  generateSeats();
}

function generateSeats(){
  const seatContainer=document.getElementById('seatContainer');
  seatContainer.innerHTML="";
  students.forEach((student,index)=>{
    const seatNumber=index+1;
    const seat=document.createElement('div');
    seat.className="bg-white p-4 rounded-lg shadow hover:shadow-lg transition relative";
    seat.dataset.present="false";
    seat.dataset.seatNumber=seatNumber;
    seat.dataset.studentName=student.name;
    seat.dataset.studentNo=student.no;
    seat.innerHTML=`<p class="font-semibold">Seat ${seatNumber} - ${student.no} ${student.name}</p>
      <span class="px-2 py-1 text-xs rounded-full bg-red-200 text-red-800">Absent</span>
      <button onclick="removeStudent(${index})" class="absolute top-1 right-1 text-red-500 hover:text-red-700 text-sm">Remove</button>`;
    seat.onclick=()=>toggleSeat(seat);
    seatContainer.appendChild(seat);
  });
}
 
function toggleSeat(seat){
  const isPresent=seat.dataset.present==="true";
  seat.dataset.present=!isPresent;
  seat.innerHTML=`<p class="font-semibold">Seat ${seat.dataset.seatNumber} - ${seat.dataset.studentName}</p>
      <span class="px-2 py-1 text-xs rounded-full ${!isPresent?"bg-green-200 text-green-800":"bg-red-200 text-red-800"}">${!isPresent?"Present":"Absent"}</span>
      <button onclick="removeStudent(${seat.dataset.seatNumber-1})" class="absolute top-1 right-1 text-red-500 hover:text-red-700 text-sm">Remove</button>`;
}
function removeStudent(index){students.splice(index,1);generateSeats();}
function markAllPresent(){document.querySelectorAll("#seatContainer div").forEach(seat=>{seat.dataset.present="true";toggleSeat(seat);});}
function resetSeats(){document.querySelectorAll("#seatContainer div").forEach(seat=>{seat.dataset.present="false";toggleSeat(seat);});}

// TABS
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.dataset.tab;
    document.querySelectorAll('.tab-section').forEach(s=>s.classList.add('hidden'));
    document.getElementById(tab).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
    btn.classList.add('bg-indigo-600','text-white');
    stopCamera();
    if(tab==="qrScanner") startCamera();
  });
});

// QR CAMERA
let html5QrCode=null;
function startCamera(){
  if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps:10, qrbox:250 },
    qrCodeMessage=>{markSeatFromQR(qrCodeMessage);}
  ).catch(err=>console.error(err));
}
document.getElementById("startCameraBtn").addEventListener('click',startCamera);
function stopCamera(){if(html5QrCode){html5QrCode.stop().then(()=>{}).catch(()=>{}); html5QrCode=null;}}
function captureQR(){if(html5QrCode){html5QrCode.scanFileV2().then(code=>{markSeatFromQR(code);}).catch(()=>{});}}

// QR Manual
document.getElementById('manualSubmit').addEventListener('click',()=>{
  const code=document.getElementById('manualQr').value.trim();
  if(code) markSeatFromQR(code);
});
function markSeatFromQR(data){
  const seat=Array.from(document.querySelectorAll("#seatContainer div"))
    .find(s=>`${s.dataset.seatNumber}-${s.dataset.studentName}`===data);
  if(seat) toggleSeat(seat);
}

// QR GENERATOR
document.getElementById('generateBtn').addEventListener('click',()=>{
  const seat=document.getElementById('genSeat').value.trim();
  const name=document.getElementById('genName').value.trim();
  if(!seat||!name) return alert("Enter seat number and name");
  const qrDiv=document.getElementById('qrcode'); qrDiv.innerHTML="";
  new QRCode(qrDiv,{text:`${seat}-${name}`,width:128,height:128});
  setTimeout(()=>{document.getElementById('downloadLink').href=qrDiv.querySelector('img').src; document.getElementById('downloadLink').download=`${name}.png`;},100);
});
document.getElementById('generateAllBtn').addEventListener('click',()=>{
  const allDiv=document.getElementById('allQRCodes'); allDiv.innerHTML="";
  students.forEach((name,index)=>{
    const seat=index+1;
    const wrapper=document.createElement('div'); wrapper.className="text-center";
    const div=document.createElement('div'); wrapper.appendChild(div);
    const p=document.createElement('p'); p.textContent=`${seat}-${name}`; p.className="text-xs mt-1"; wrapper.appendChild(p);
    new QRCode(div,{text:`${seat}-${name}`,width:100,height:100});
    allDiv.appendChild(wrapper);
  });
});

// PDF PREVIEW
async function generatePdfPreview(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape','pt','a4');
  doc.setFontSize(14); doc.text("Monthly Class Attendance",40,30);
  doc.text("Teacher: Mrs. Joana Marie Amil",40,50);
  doc.text("Grade & Section: ",40,70);
  doc.text("School Year: 2025",40,90);
  doc.text("Month: October",40,110);

  const colHeaders=["ID","Student Name"];
  const monthDays=31; const weekdays=["Mon","Tue","Wed","Thu","Fri"];
  for(let d=1; d<=monthDays; d++){
    const date=new Date(2025,9,d);
    const dayName=weekdays[date.getDay()-1]||"";
    if(dayName) colHeaders.push(`${dayName} ${d}`);
  }

  const rows=students.map((name,index)=>{
    const row=[index+1,name];
    for(let d=1; d<=monthDays; d++){
      const date=new Date(2025,9,d);
      const dayName=weekdays[date.getDay()-1]||"";
      if(dayName){
        const seatDiv=document.querySelector(`#seatContainer div[data-seat-number='${index+1}']`);
        const present = seatDiv && seatDiv.dataset.present==="true"?"P":"A";
        row.push(present);
      }
    }
    return row;
  });

  doc.autoTable({startY:140,head:[colHeaders],body:rows,theme:'grid',styles:{fontSize:7,cellPadding:3},headStyles:{fillColor:[41,128,185],textColor:255},showHead:'everyPage',margin:{top:140,left:40,right:40}});
  const pdfUrl=doc.output('bloburl'); document.getElementById('pdfPreviewFrame').src=pdfUrl;
  document.getElementById('downloadPdfBtn').onclick=()=>{doc.save("Monthly_Attendance.pdf");};
}
</script>
</body>
</html>
